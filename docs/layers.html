---

title: Layers

keywords: fastai
sidebar: home_sidebar

summary: "Definitions and patches of layers"
description: "Definitions and patches of layers"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_layers.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><h1>Table of Contents<span class="tocSkip"></span></h1></p>
<div class="toc"><ul class="toc-item"><li><span><a href="#Layers" data-toc-modified-id="Layers-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Layers</a></span><ul class="toc-item"><li><span><a href="#Patches" data-toc-modified-id="Patches-1.1"><span class="toc-item-num">1.1&nbsp;&nbsp;</span>Patches</a></span><ul class="toc-item"><li><span><a href="#RoIHeads" data-toc-modified-id="RoIHeads-1.1.1"><span class="toc-item-num">1.1.1&nbsp;&nbsp;</span>RoIHeads</a></span></li><li><span><a href="#GeneralizedRCNN" data-toc-modified-id="GeneralizedRCNN-1.1.2"><span class="toc-item-num">1.1.2&nbsp;&nbsp;</span>GeneralizedRCNN</a></span></li></ul></li></ul></li><li><span><a href="#Export" data-toc-modified-id="Export-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Export</a></span></li></ul></div>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Patches">Patches<a class="anchor-link" href="#Patches"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="RoIHeads">RoIHeads<a class="anchor-link" href="#RoIHeads"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># DEPRECATED</span>
<span class="nd">@patch</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="n">RoIHeads</span><span class="p">,</span>
            <span class="n">features</span><span class="p">,</span>      <span class="c1"># type: Dict[str, Tensor]</span>
            <span class="n">proposals</span><span class="p">,</span>     <span class="c1"># type: List[Tensor]</span>
            <span class="n">image_shapes</span><span class="p">,</span>  <span class="c1"># type: List[Tuple[int, int]]</span>
            <span class="n">targets</span><span class="o">=</span><span class="kc">None</span>   <span class="c1"># type: Optional[List[Dict[str, Tensor]]]</span>
            <span class="p">):</span>
    <span class="c1"># type: (...) -&gt; Tuple[List[Dict[str, Tensor]], Dict[str, Tensor]]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        features (List[Tensor])</span>
<span class="sd">        proposals (List[Tensor[N, 4]])</span>
<span class="sd">        image_shapes (List[Tuple[H, W]])</span>
<span class="sd">        targets (List[Dict])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="c1"># TODO: https://github.com/pytorch/pytorch/issues/26731</span>
            <span class="n">floating_point_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">half</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="n">floating_point_types</span><span class="p">,</span> <span class="s1">&#39;target boxes must of float type&#39;</span>
            <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="s1">&#39;target labels must of int64 type&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_keypoint</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;target keypoints must of float type&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">regression_targets</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">matched_idxs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">proposals</span><span class="p">,</span> <span class="n">matched_idxs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">regression_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_training_samples</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

    <span class="n">box_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_roi_pool</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">proposals</span><span class="p">,</span> <span class="n">image_shapes</span><span class="p">)</span>
    <span class="n">box_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_head</span><span class="p">(</span><span class="n">box_features</span><span class="p">)</span>
    <span class="n">class_logits</span><span class="p">,</span> <span class="n">box_regression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_predictor</span><span class="p">(</span><span class="n">box_features</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span> <span class="p">[])</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">regression_targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">loss_classifier</span><span class="p">,</span> <span class="n">loss_box_reg</span> <span class="o">=</span> <span class="n">fastrcnn_loss</span><span class="p">(</span>
            <span class="n">class_logits</span><span class="p">,</span> <span class="n">box_regression</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">regression_targets</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;loss_classifier&quot;</span><span class="p">:</span> <span class="n">loss_classifier</span><span class="p">,</span>
            <span class="s2">&quot;loss_box_reg&quot;</span><span class="p">:</span> <span class="n">loss_box_reg</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
        <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_detections</span><span class="p">(</span><span class="n">class_logits</span><span class="p">,</span> <span class="n">box_regression</span><span class="p">,</span> <span class="n">proposals</span><span class="p">,</span> <span class="n">image_shapes</span><span class="p">)</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mask</span><span class="p">():</span>
        <span class="n">mask_proposals</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">pos_matched_idxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">matched_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># during training, only focus on positive boxes</span>
            <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
            <span class="n">mask_proposals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pos_matched_idxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mask_proposals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                <span class="n">pos_matched_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_idxs</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_roi_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_roi_pool</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">mask_proposals</span><span class="p">,</span> <span class="n">image_shapes</span><span class="p">)</span>
            <span class="n">mask_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_head</span><span class="p">(</span><span class="n">mask_features</span><span class="p">)</span>
            <span class="n">mask_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_predictor</span><span class="p">(</span><span class="n">mask_features</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected mask_roi_pool to be not None&quot;</span><span class="p">)</span>

        <span class="n">loss_mask</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">pos_matched_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">mask_logits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">gt_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>
            <span class="n">gt_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>
            <span class="n">rcnn_loss_mask</span> <span class="o">=</span> <span class="n">maskrcnn_loss</span><span class="p">(</span>
                <span class="n">mask_logits</span><span class="p">,</span> <span class="n">mask_proposals</span><span class="p">,</span>
                <span class="n">gt_masks</span><span class="p">,</span> <span class="n">gt_labels</span><span class="p">,</span> <span class="n">pos_matched_idxs</span><span class="p">)</span>
            <span class="n">loss_mask</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;loss_mask&quot;</span><span class="p">:</span> <span class="n">rcnn_loss_mask</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
            <span class="n">masks_probs</span> <span class="o">=</span> <span class="n">maskrcnn_inference</span><span class="p">(</span><span class="n">mask_logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mask_prob</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">masks_probs</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_prob</span>

        <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_mask</span><span class="p">)</span>

    <span class="c1"># keep none checks in if conditional so torchscript will conditionally</span>
    <span class="c1"># compile each branch</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_roi_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_predictor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keypoint_proposals</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">pos_matched_idxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># during training, only focus on positive boxes</span>
            <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
            <span class="n">keypoint_proposals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pos_matched_idxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">assert</span> <span class="n">matched_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">keypoint_proposals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                <span class="n">pos_matched_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_idxs</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>

        <span class="n">keypoint_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_roi_pool</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">keypoint_proposals</span><span class="p">,</span> <span class="n">image_shapes</span><span class="p">)</span>
        <span class="n">keypoint_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_head</span><span class="p">(</span><span class="n">keypoint_features</span><span class="p">)</span>
        <span class="n">keypoint_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keypoint_predictor</span><span class="p">(</span><span class="n">keypoint_features</span><span class="p">)</span>

        <span class="n">loss_keypoint</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">pos_matched_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">gt_keypoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>
            <span class="n">rcnn_loss_keypoint</span> <span class="o">=</span> <span class="n">keypointrcnn_loss</span><span class="p">(</span>
                <span class="n">keypoint_logits</span><span class="p">,</span> <span class="n">keypoint_proposals</span><span class="p">,</span>
                <span class="n">gt_keypoints</span><span class="p">,</span> <span class="n">pos_matched_idxs</span><span class="p">)</span>
            <span class="n">loss_keypoint</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;loss_keypoint&quot;</span><span class="p">:</span> <span class="n">rcnn_loss_keypoint</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">keypoint_logits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">keypoint_proposals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">keypoints_probs</span><span class="p">,</span> <span class="n">kp_scores</span> <span class="o">=</span> <span class="n">keypointrcnn_inference</span><span class="p">(</span><span class="n">keypoint_logits</span><span class="p">,</span> <span class="n">keypoint_proposals</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">keypoint_prob</span><span class="p">,</span> <span class="n">kps</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keypoints_probs</span><span class="p">,</span> <span class="n">kp_scores</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keypoint_prob</span>
                <span class="n">r</span><span class="p">[</span><span class="s2">&quot;keypoints_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kps</span>

        <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_keypoint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">losses</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="GeneralizedRCNN">GeneralizedRCNN<a class="anchor-link" href="#GeneralizedRCNN"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># DEPRECATED</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">unused</span>
<span class="nd">@patch</span>
<span class="k">def</span> <span class="nf">eager_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="n">GeneralizedRCNN</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>
    <span class="c1"># type: (Dict[str, Tensor], List[Dict[str, Tensor]]) -&gt; Tuple[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
    <span class="k">if</span> <span class="n">losses</span> <span class="ow">and</span> <span class="n">detections</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">detections</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">losses</span><span class="p">:</span> <span class="k">return</span> <span class="n">losses</span>
    <span class="k">if</span> <span class="n">detections</span><span class="p">:</span> <span class="k">return</span> <span class="n">detections</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Export">Export<a class="anchor-link" href="#Export"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_core.ipynb.
Converted 01_layers.ipynb.
Converted 02_data.core.ipynb.
Converted 04_data.annotations.ipynb.
Converted 06_data.load.ipynb.
Converted 07_transforms.ipynb.
Converted 08_models.ipynb.
Converted 11_metrics.core.ipynb.
Converted Untitled.ipynb.
Converted Untitled1.ipynb.
Converted data_refactor.ipynb.
Converted index.ipynb.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

